<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Trading & P&L Flowchart</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #2ec4b6;
            --danger: #f72585;
            --warning: #ff9e00;
            --info: #4cc9f0;
            --dark: #212529;
            --light: #f8f9fa;
            --dark-bg: #121218;
            --dark-card: #1e1e2d;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        body.dark-mode {
            background: var(--dark-bg);
            color: #f0f0f0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        h1 {
            color: var(--secondary);
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            display: inline-block;
        }
        
        body.dark-mode h1 {
            color: var(--info);
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--danger);
            border-radius: 2px;
        }
        
        .flow-description {
            max-width: 800px;
            margin: 0 auto 40px;
            color: #555;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        body.dark-mode .flow-description {
            color: #aaa;
        }
        
        .flowchart-container {
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            background: white;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        body.dark-mode .flowchart-container {
            background: var(--dark-card);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .flowchart {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            position: relative;
            margin: 40px auto;
            min-height: 500px;
        }
        
        .stage-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .stage {
            color: white;
            padding: 18px 25px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            min-width: 220px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            font-weight: 500;
            border: none;
            z-index: 3;
        }
        
        .stage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            z-index: 1;
        }
        
        .stage:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.2);
        }
        
        .stage.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px white, 0 12px 25px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .stage.active {
            box-shadow: 0 0 0 3px var(--dark-card), 0 12px 25px rgba(0,0,0,0.5);
        }
        
        .stage.completed::after {
            content: '‚úì';
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--success);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .stage span {
            position: relative;
            z-index: 2;
        }
        
        /* Colors for categories */
        .start-end { 
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%); 
        }
        
        .ui { 
            background: linear-gradient(135deg, var(--primary) 0%, #3a86ff 100%); 
        }
        
        .processing { 
            background: linear-gradient(135deg, #7209b7 0%, var(--secondary) 100%); 
        }
        
        .output { 
            background: linear-gradient(135deg, var(--danger) 0%, #b5179e 100%); 
        }
        
        .connection-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .connection-path line {
            stroke: #4361ee;
            stroke-width: 3;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 1.5s ease-in-out forwards;
            opacity: 0.6;
        }
        
        body.dark-mode .connection-path line {
            stroke: #4cc9f0;
        }
        
        @keyframes draw {
            to { stroke-dashoffset: 0; }
        }
        
        .arrow {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 24px;
            transform: rotate(90deg);
            z-index: 2;
        }
        
        body.dark-mode .arrow {
            color: #aaa;
        }
        
        .tooltip {
            display: none;
            position: absolute;
            background: white;
            color: var(--dark);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            max-width: 400px;
            text-align: left;
            z-index: 100;
            border-left: 5px solid var(--danger);
            animation: fadeIn 0.3s ease;
        }
        
        body.dark-mode .tooltip {
            background: var(--dark-card);
            color: #f0f0f0;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .tooltip h3 {
            margin-top: 0;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 15px;
            position: relative;
            padding-bottom: 10px;
        }
        
        body.dark-mode .tooltip h3 {
            color: var(--info);
        }
        
        .tooltip h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--warning);
            border-radius: 3px;
        }
        
        .tooltip p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .tooltip strong {
            color: var(--secondary);
        }
        
        body.dark-mode .tooltip strong {
            color: var(--info);
        }
        
        .group-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            position: relative;
            display: inline-block;
            background: rgba(255,255,255,0.9);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .group-title {
            color: #f0f0f0;
            background: rgba(30, 30, 45, 0.9);
        }
        
        .group-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), transparent);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }
        
        .btn-secondary {
            background: var(--warning);
            box-shadow: 0 4px 10px rgba(255, 158, 0, 0.3);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 15px rgba(255, 158, 0, 0.4);
        }
        
        .btn-danger {
            background: var(--danger);
            box-shadow: 0 4px 10px rgba(247, 37, 133, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 15px rgba(247, 37, 133, 0.4);
        }
        
        .btn-success {
            background: var(--success);
            box-shadow: 0 4px 10px rgba(46, 196, 182, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 15px rgba(46, 196, 182, 0.4);
        }
        
        .progress-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background: #e9ecef;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
        }
        
        body.dark-mode .progress-container {
            background: #2a2a3a;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 350px;
            overflow: hidden;
            z-index: 1000;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        body.dark-mode .ai-assistant {
            background: var(--dark-card);
        }
        
        .ai-assistant.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .ai-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-body {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ai-message {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        body.dark-mode .ai-message {
            background: #2a2a3a;
        }
        
        .ai-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        
        body.dark-mode .ai-input {
            border-top: 1px solid #333;
        }
        
        .ai-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        body.dark-mode .ai-input input {
            background: #2a2a3a;
            border: 1px solid #444;
            color: white;
        }
        
        .toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            border: none;
        }
        
        @media (min-width: 992px) {
            .arrow {
                transform: rotate(0);
            }
            
            .flowchart {
                flex-wrap: nowrap;
                align-items: center;
            }
            
            .stage-group {
                gap: 25px;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .stage {
                min-width: 200px;
                padding: 15px 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .ai-assistant {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive Trading & P&L Flowchart</h1>
        <p class="flow-description">Visualize the complete financial statement generation process with this interactive flowchart</p>
        
        <div class="controls">
            <button id="darkModeBtn" class="btn">
                <span>üåô</span> Dark Mode
            </button>
            <button id="exportBtn" class="btn btn-secondary">
                <span>üì∑</span> Export as Image
            </button>
            <button id="resetBtn" class="btn btn-danger">
                <span>üîÑ</span> Reset Progress
            </button>
            <button id="tutorialBtn" class="btn btn-success">
                <span>üéì</span> Start Tutorial
            </button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="flowchart-container">
            <div class="flowchart" id="flowchart">
                <!-- SVG connections will be added by JavaScript -->
                <svg class="connection-path" id="connectionPath"></svg>
                
                <!-- Start Group -->
                <div class="stage-group">
                    <div class="group-title">Initiation</div>
                    <div class="stage start-end" id="startStage"
                         data-title="Start Process" 
                         data-info="The financial reporting workflow begins here, ready to accept user inputs and actions." 
                         data-code="System initialization completes, UI components are loaded, and event listeners are activated.">
                        <span>Start Process</span>
                    </div>
                </div>
                
                <div class="arrow">‚Üí</div>
                
                <!-- User Interface Group -->
                <div class="stage-group">
                    <div class="group-title">User Actions</div>
                    <div class="stage ui" 
                         data-title="Download PDF Template" 
                         data-info="Retrieves a blank PDF template or previous report for reference or editing." 
                         data-code="PDF generation API call with template flag set to true, returns PDF as downloadable attachment.">
                        <span>Download PDF Template</span>
                    </div>
                    
                    <div class="stage ui" 
                         data-title="Upload Trial Balance" 
                         data-info="User uploads CSV file containing trial balance data for processing." 
                         data-code="FileReader API processes CSV, validates structure, and stores data in memory for calculations.">
                        <span>Upload Trial Balance</span>
                    </div>
                    
                    <div class="stage ui" 
                         data-title="Generate Statements" 
                         data-info="Initiates financial statement generation based on the uploaded trial balance data." 
                         data-code="Triggers backend processing pipeline with user data as input parameters.">
                        <span>Generate Statements</span>
                    </div>
                    
                    <div class="stage ui" 
                         data-title="Enter Closing Stock" 
                         data-info="Manual input of closing stock valuation for accurate trading account calculation." 
                         data-code="Input validation ensures numeric value, stored in state management for calculations.">
                        <span>Enter Closing Stock</span>
                    </div>
                    
                    <div class="stage ui" 
                         data-title="Download Sample CSV" 
                         data-info="Provides reference CSV format to ensure proper data structure for upload." 
                         data-code="Pre-formatted CSV file served from static assets with example ledger entries.">
                        <span>Download Sample CSV</span>
                    </div>
                </div>
                
                <div class="arrow">‚Üí</div>
                
                <!-- Processing Group -->
                <div class="stage-group">
                    <div class="group-title">Data Processing</div>
                    <div class="stage processing" 
                         data-title="Parse & Validate CSV" 
                         data-info="System reads and validates CSV structure, checking for required columns and data types." 
                         data-code="CSV parser checks header row, validates numeric values, and ensures debit/credit balance.">
                        <span>Parse & Validate CSV</span>
                    </div>
                    
                    <div class="stage processing" 
                         data-title="Classify Ledger Items" 
                         data-info="Categorizes trial balance entries into assets, liabilities, income, and expenses." 
                         data-code="Mapping algorithm uses account codes and naming patterns to classify each entry.">
                        <span>Classify Ledger Items</span>
                    </div>
                    
                    <div class="stage processing" 
                         data-title="Calculate Trading Account" 
                         data-info="Computes gross profit/loss by comparing sales against cost of goods sold." 
                         data-code="Formula: Gross Profit = Sales - (Opening Stock + Purchases - Closing Stock)">
                        <span>Calculate Trading Account</span>
                    </div>
                    
                    <div class="stage processing" 
                         data-title="Calculate P&L Account" 
                         data-info="Determines net profit/loss by considering all incomes and expenses." 
                         data-code="Net Profit = Gross Profit + Other Incomes - All Expenses">
                        <span>Calculate P&L Account</span>
                    </div>
                    
                    <div class="stage processing" 
                         data-title="Verify Trial Balance" 
                         data-info="Final validation ensuring total debits equal total credits for accounting accuracy." 
                         data-code="Debit/Credit summation comparison with tolerance threshold for rounding errors.">
                        <span>Verify Trial Balance</span>
                    </div>
                </div>
                
                <div class="arrow">‚Üí</div>
                
                <!-- Output Group -->
                <div class="stage-group">
                    <div class="group-title">Results Output</div>
                    <div class="stage output" 
                         data-title="Download Financial Statements" 
                         data-info="Generates and delivers comprehensive PDF report with all financial statements." 
                         data-code="PDFKit generates multi-page document with formatted tables, charts, and summary.">
                        <span>Download Financial Statements</span>
                    </div>
                    
                    <div class="stage output" 
                         data-title="View Trial Balance" 
                         data-info="Interactive table display of the uploaded trial balance data with sorting." 
                         data-code="React-table component renders paginated, sortable table with search functionality.">
                        <span>View Trial Balance</span>
                    </div>
                    
                    <div class="stage output" 
                         data-title="View Trading Account" 
                         data-info="Detailed trading account showing gross profit calculation breakdown." 
                         data-code="Dynamic HTML table with expandable sections for cost of goods sold details.">
                        <span>View Trading Account</span>
                    </div>
                    
                    <div class="stage output" 
                         data-title="View P&L Account" 
                         data-info="Complete profit and loss statement with expense categorization." 
                         data-code="Interactive chart visualization alongside tabular data with percentage breakdowns.">
                        <span>View P&L Account</span>
                    </div>
                    
                    <div class="stage output" 
                         data-title="Financial Summary" 
                         data-info="Key metrics and highlights extracted from the financial statements." 
                         data-code="Calculates and displays ratios like gross margin, net margin, and expense percentages.">
                        <span>Financial Summary</span>
                    </div>
                </div>
                
                <div class="arrow">‚Üí</div>
                
                <!-- End Group -->
                <div class="stage-group">
                    <div class="group-title">Completion</div>
                    <div class="stage start-end" id="endStage"
                         data-title="Process Complete" 
                         data-info="All financial statements have been generated and are available to the user." 
                         data-code="System logs completion event, resets necessary states, and awaits new user action.">
                        <span>Process Complete</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>
    
    <button class="toggle-btn" id="aiToggle">ü§ñ</button>
    
    <div class="ai-assistant" id="aiAssistant">
        <div class="ai-header">
            <span>Financial Flow Assistant</span>
            <button id="closeAi" style="background: none; border: none; color: white; font-size: 20px;">√ó</button>
        </div>
        <div class="ai-body" id="aiBody">
            <div class="ai-message">
                Hello! I'm your financial flowchart assistant. Ask me anything about the process steps or accounting concepts.
            </div>
        </div>
        <div class="ai-input">
            <input type="text" id="aiInput" placeholder="Ask a question about the flowchart...">
        </div>
    </div>

    <script>
        // DOM Elements
        const stages = document.querySelectorAll(".stage");
        const tooltip = document.getElementById("tooltip");
        const darkModeBtn = document.getElementById("darkModeBtn");
        const exportBtn = document.getElementById("exportBtn");
        const resetBtn = document.getElementById("resetBtn");
        const tutorialBtn = document.getElementById("tutorialBtn");
        const progressBar = document.getElementById("progressBar");
        const aiToggle = document.getElementById("aiToggle");
        const aiAssistant = document.getElementById("aiAssistant");
        const closeAi = document.getElementById("closeAi");
        const aiBody = document.getElementById("aiBody");
        const aiInput = document.getElementById("aiInput");
        const connectionPath = document.getElementById("connectionPath");
        const flowchart = document.getElementById("flowchart");
        
        // State variables
        let activeStage = null;
        let completedStages = new Set();
        let isTutorialMode = false;
        let tutorialStep = 0;
        const totalStages = stages.length;
        
        // Initialize connections
        function drawConnections() {
            // Clear existing connections
            connectionPath.innerHTML = '';
            
            // Get all stage groups
            const groups = document.querySelectorAll('.stage-group');
            
            // Draw connections between groups
            for (let i = 0; i < groups.length - 1; i++) {
                const currentGroup = groups[i];
                const nextGroup = groups[i + 1];
                
                const lastStage = currentGroup.querySelector('.stage:last-child');
                const firstStage = nextGroup.querySelector('.stage:first-child');
                
                if (lastStage && firstStage) {
                    const startRect = lastStage.getBoundingClientRect();
                    const endRect = firstStage.getBoundingClientRect();
                    
                    const startX = startRect.right + window.scrollX;
                    const startY = startRect.top + window.scrollY + startRect.height / 2;
                    const endX = endRect.left + window.scrollX;
                    const endY = endRect.top + window.scrollY + endRect.height / 2;
                    
                    // Create a line connecting the two stages
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", startX);
                    line.setAttribute("y1", startY);
                    line.setAttribute("x2", endX);
                    line.setAttribute("y2", endY);
                    line.setAttribute("stroke-dasharray", "1000");
                    line.setAttribute("stroke-dashoffset", "1000");
                    
                    // Add animation with delay based on group position
                    line.style.animation = `draw 1.5s ease-in-out ${i * 0.2}s forwards`;
                    
                    connectionPath.appendChild(line);
                }
            }
        }
        
        // Update progress bar
        function updateProgress() {
            const progress = (completedStages.size / totalStages) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        // Stage click handler
        function handleStageClick(stage, e) {
            e.stopPropagation();
            
            // Remove active class from all stages
            stages.forEach(s => s.classList.remove('active'));
            
            // Add active class to clicked stage
            stage.classList.add('active');
            activeStage = stage;
            
            // Add to completed stages if not already there
            if (!completedStages.has(stage)) {
                completedStages.add(stage);
                stage.classList.add('completed');
                updateProgress();
                
                // Play completion sound
                const sound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3');
                sound.volume = 0.3;
                sound.play();
            }
            
            // Update tooltip content
            tooltip.innerHTML = `
                <h3>${stage.getAttribute("data-title")}</h3>
                <p><strong>Business Logic:</strong> ${stage.getAttribute("data-info")}</p>
                <p><strong>Technical Implementation:</strong> ${stage.getAttribute("data-code")}</p>
            `;
            
            // Position and show tooltip
            tooltip.style.display = "block";
            
            const rect = stage.getBoundingClientRect();
            let top = rect.bottom + window.scrollY + 10;
            let left = rect.left + window.scrollX;
            
            // Adjust if too close to right edge
            if (left + tooltip.offsetWidth > window.innerWidth) {
                left = window.innerWidth - tooltip.offsetWidth - 20;
            }
            
            // Adjust if too close to bottom
            if (top + tooltip.offsetHeight > window.innerHeight + window.scrollY) {
                top = rect.top + window.scrollY - tooltip.offsetHeight - 10;
            }
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }
        
        // Initialize stage event listeners
        function initStages() {
            stages.forEach(stage => {
                // Click handler
                stage.addEventListener("click", (e) => handleStageClick(stage, e));
                
                // Hover effects
                stage.addEventListener('mouseenter', () => {
                    if (!stage.classList.contains('active')) {
                        stage.style.transform = 'translateY(-5px)';
                        stage.style.boxShadow = '0 15px 25px rgba(0,0,0,0.15)';
                    }
                });
                
                stage.addEventListener('mouseleave', () => {
                    if (!stage.classList.contains('active')) {
                        stage.style.transform = '';
                        stage.style.boxShadow = '';
                    }
                });
            });
        }
        
        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            darkModeBtn.innerHTML = isDark ? '<span>‚òÄÔ∏è</span> Light Mode' : '<span>üåô</span> Dark Mode';
            localStorage.setItem('darkMode', isDark);
        }
        
        // Export as image
        function exportAsImage() {
            const notification = document.createElement('div');
            notification.textContent = 'Exporting image...';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'var(--primary)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '20px';
            notification.style.zIndex = '1000';
            document.body.appendChild(notification);
            
            html2canvas(flowchart, {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true,
                backgroundColor: document.body.classList.contains('dark-mode') ? '#121218' : '#f5f7fa'
            }).then(canvas => {
                canvas.toBlob(blob => {
                    saveAs(blob, 'financial-flowchart.png');
                    notification.textContent = 'Image exported successfully!';
                    setTimeout(() => notification.remove(), 2000);
                });
            });
        }
        
        // Reset progress
        function resetProgress() {
            stages.forEach(stage => {
                stage.classList.remove('completed', 'active');
            });
            completedStages.clear();
            updateProgress();
            activeStage = null;
            tooltip.style.display = "none";
        }
        
        // Start tutorial
        function startTutorial() {
            isTutorialMode = true;
            tutorialStep = 0;
            resetProgress();
            
            const tutorialSteps = [
                { element: document.getElementById('startStage'), message: 'Welcome! This is where the financial reporting process begins.' },
                { element: document.querySelector('.ui.stage'), message: 'First, users interact with the interface to upload data and configure reports.' },
                { element: document.querySelector('.processing.stage'), message: 'The system then processes and validates the financial data.' },
                { element: document.querySelector('.output.stage'), message: 'Finally, the results are generated and presented to the user.' },
                { element: document.getElementById('endStage'), message: 'The process completes when all statements are available.' }
            ];
            
            function nextTutorialStep() {
                if (tutorialStep >= tutorialSteps.length) {
                    isTutorialMode = false;
                    addAiMessage("Tutorial completed! You can now explore the flowchart on your own or ask me questions.");
                    return;
                }
                
                const step = tutorialSteps[tutorialStep];
                step.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                handleStageClick(step.element, { stopPropagation: () => {} });
                
                addAiMessage(step.message);
                addAiMessage("Click the highlighted step to learn more, then click anywhere else to continue the tutorial.");
                
                tutorialStep++;
            }
            
            // Click anywhere to advance tutorial
            document.addEventListener('click', function advanceTutorial(e) {
                if (isTutorialMode && !e.target.classList.contains('stage')) {
                    nextTutorialStep();
                }
            }, { once: true });
            
            nextTutorialStep();
        }
        
        // AI Assistant functions
        function toggleAiAssistant() {
            aiAssistant.classList.toggle('active');
        }
        
        function addAiMessage(message, isUser = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'ai-message';
            if (isUser) msgDiv.style.textAlign = 'right';
            msgDiv.textContent = message;
            aiBody.appendChild(msgDiv);
            aiBody.scrollTop = aiBody.scrollHeight;
        }
        
        function handleAiQuestion() {
            const question = aiInput.value.trim();
            if (!question) return;
            
            addAiMessage(question, true);
            aiInput.value = '';
            
            // Simple response logic - in a real app you'd call an API
            const responses = [
                "The trading account calculates gross profit by subtracting cost of goods sold from sales revenue.",
                "You need to upload a CSV file with columns for account name, debit amount, and credit amount.",
                "Closing stock value is entered manually because it often comes from physical inventory counts.",
                "The system validates that total debits equal total credits before generating reports.",
                "Financial statements include Trading Account, Profit & Loss Account, and Balance Sheet.",
                "You can download sample CSV to see the required format for trial balance data."
            ];
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'ai-message';
            typingIndicator.textContent = '...';
            aiBody.appendChild(typingIndicator);
            
            // Simulate AI thinking time
            setTimeout(() => {
                typingIndicator.remove();
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addAiMessage(randomResponse);
            }, 1000 + Math.random() * 2000);
        }
        
        // Initialize event listeners
        function initEventListeners() {
            // Click anywhere to close tooltip
            document.addEventListener("click", (e) => {
                if (!e.target.classList.contains("stage")) {
                    tooltip.style.display = "none";
                    if (activeStage) {
                        activeStage.classList.remove('active');
                        activeStage = null;
                    }
                }
            });
            
            // Close tooltip on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    tooltip.style.display = "none";
                    if (activeStage) {
                        activeStage.classList.remove('active');
                        activeStage = null;
                    }
                }
            });
            
            // Control buttons
            darkModeBtn.addEventListener('click', toggleDarkMode);
            exportBtn.addEventListener('click', exportAsImage);
            resetBtn.addEventListener('click', resetProgress);
            tutorialBtn.addEventListener('click', startTutorial);
            
            // AI Assistant
            aiToggle.addEventListener('click', toggleAiAssistant);
            closeAi.addEventListener('click', toggleAiAssistant);
            aiInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAiQuestion();
            });
            
            // Window resize - redraw connections
            window.addEventListener('resize', drawConnections);
        }
        
        // Initialize app
        function init() {
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                toggleDarkMode();
            }
            
            initStages();
            initEventListeners();
            drawConnections();
            
            // Add sample financial data to tooltips (simulated)
            setTimeout(() => {
                const tradingStage = document.querySelector('[data-title="Calculate Trading Account"]');
                tradingStage.setAttribute('data-code', 
                    `Gross Profit = Sales (‚Çπ1,250,000) - COGS (‚Çπ850,000) = ‚Çπ400,000`);
                
                const plStage = document.querySelector('[data-title="Calculate P&L Account"]');
                plStage.setAttribute('data-code', 
                    `Net Profit = Gross Profit (‚Çπ400,000) + Other Income (‚Çπ50,000) - Expenses (‚Çπ300,000) = ‚Çπ150,000`);
            }, 1000);
            
            // Welcome message
            setTimeout(() => {
                addAiMessage("Welcome to your Financial Flowchart Assistant! Try clicking on any step to learn more, or ask me a question about accounting processes.");
            }, 2000);
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
